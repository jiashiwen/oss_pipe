# 设计与实现机制

## 断点续传实现机制

* 预下载object list
* 执行时记录扫描object list，的offset
* 出现错误记录errorlog
* 断点续传时先解析errorlog中出错记录，在将从offset开始同步
* 报错记录超过阀值停止任务，并执行完成所有未完任务
* 记录key的值和列表文件offset，报错时记录key值及offset，断点续传时比较最小的offset作为起点

### 改进

* 为提高运行效率尽量避免磁盘io
* 通过每个批次任务不断写入offset ，key 为 key_第一个offset，
* 定时比对offset 中的最小值作为 checkpoint

## 增量实现机制

### 源为OSS的增量实现机制

* 遍历 object
* 筛选lastmodify 时间戳大于前次同步开始时间戳的object
* 同步 objcet
* 循环以上步骤
  
### 源为文件系统的增量实现机制

#### 源为文件系统

* notify 监控要同步的目录
* 生成增量文件
* 读取文件并执行增量任务，并记录文件offset
* 当offset为文件长度时，中断增量任务
* 定时检查文件长度，当文件长度增长时从offset读取文件执行同步动作，知道offset与文件长度相当。循环执行该步骤

#### 源为oss

* 通过本地存量列表与源对比生成已删除的对象列表
* 通过执行上次操作的其实时间戳遍历源端生成增量对象列表

## 错误处理机制

* 累加错误记录，当错误数达到阀值除非任务停止
* 数据传输执行期间任务停止，再断点续传开始前充实错误记录，若重试不成功需要人工介入修正错误记录或忽略

## 校验机制
